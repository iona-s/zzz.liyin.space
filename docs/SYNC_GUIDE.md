# 数据同步使用指南

## 概述

数据同步功能允许您将成就数据、角色设置等信息存储在服务器上，实现多设备同步和数据备份。

## 快速开始

### 1. 启动后端服务器

```bash
cd server
npm install
npm start
```

服务器将在 `http://localhost:3000` 启动

### 2. 启动前端

```bash
npm install
npm run dev
```

### 3. 配置同步

1. 打开应用后，进入"设置"页面
2. 找到"数据同步"部分
3. 检查服务器状态是否显示"服务器在线"
4. 启用"自动同步"开关

## 功能说明

### 自动同步

- 启用后，数据每30秒自动同步到服务器
- 当服务器离线时，自动切换到本地存储模式
- 服务器恢复后，会自动同步最新数据

### 手动同步

- 点击"立即同步"按钮可手动触发数据同步
- 适用于想要确保数据已保存的场景

### 服务器状态检查

- 点击"检查服务器"按钮可测试与服务器的连接
- 服务器状态会实时显示在界面上

## 数据同步内容

以下数据会被同步：

1. **用户信息**
   - 账号列表
   - 头像、UID、昵称等

2. **成就数据**
   - 所有成就的完成状态
   - 成就进度

3. **角色设置**
   - 性别选择等个性化设置

4. **自定义设置**
   - 暂不可获得成就的自定义列表

## 同步策略

### 冲突处理

当本地数据和服务器数据不一致时：
- 采用"最后写入优先"策略
- 本地修改会覆盖服务器数据
- 建议在单一设备上使用，避免数据冲突

### 离线模式

- 服务器离线时，应用会自动使用本地存储
- 数据修改会保存在本地
- 服务器恢复后，本地数据会同步到服务器

## 高级配置

### 修改服务器地址

编辑项目根目录的 `.env` 文件：

```env
VITE_API_URL=http://your-server-address:3000/api
```

### 部署到生产环境

1. 将 `server` 目录部署到服务器
2. 配置环境变量：
   ```bash
   export PORT=3000
   ```
3. 启动服务器：
   ```bash
   npm start
   ```
4. 在前端 `.env` 文件中配置正确的服务器地址

### 使用其他数据库

默认使用 SQLite，如需使用其他数据库，需修改 `server/database.js` 文件。

## 故障排查

### 服务器显示离线

1. 确认服务器是否正在运行
2. 检查 `.env` 文件中的 `VITE_API_URL` 配置是否正确
3. 检查防火墙是否阻止了 3000 端口
4. 尝试在浏览器访问 `http://localhost:3000/api/sync`

### 数据同步失败

1. 查看浏览器控制台（F12）的错误信息
2. 查看服务器终端的日志输出
3. 尝试手动点击"立即同步"按钮
4. 检查服务器磁盘空间是否充足

### 数据丢失

1. 服务器数据存储在 `server/data.db` 文件中
2. 可以备份此文件以防数据丢失
3. 如果服务器数据丢失，本地浏览器仍有数据缓存

## 数据备份

### 备份服务器数据

复制 `server/data.db` 文件到安全位置

### 恢复数据

将备份的 `data.db` 文件替换到 `server` 目录

### 导出本地数据

使用应用内置的"导出"功能导出 JSON 文件

## 安全提示

⚠️ **重要提示**

- **访问令牌保护**: 服务器使用令牌验证所有请求
- **令牌保密**: 不要在公共场合分享你的令牌
- **定期更换**: 建议定期更改 `server/.env` 中的令牌
- **本地使用**: 仅适用于本地或受信任网络环境
- **不要提交**: `server/.env` 文件已在 `.gitignore` 中，不会被提交
- **公网部署**: 需要添加 HTTPS、更强的认证机制等安全措施
- **数据备份**: 定期备份 `server/data.db` 文件
- 任何能访问服务器的人都可以查看和修改数据
- 建议仅在本地网络或受信任的环境中使用
- 如需公网部署，请自行添加认证机制

## 性能优化

- 对于大量数据，建议增加同步间隔
- 服务器使用 SQLite WAL 模式提高并发性能
